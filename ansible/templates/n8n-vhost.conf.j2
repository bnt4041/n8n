<VirtualHost *:80>
    ServerName {{ n8n_domain }}
    ServerAdmin webmaster@{{ n8n_domain }}

    DocumentRoot /var/www/html

    {% if enable_https|default(false)|bool %}
    # Redirección a HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule ^/(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
    {% endif %}

    # Proxy (si no se usa HTTPS todavía sigue funcionando en 80)
    ProxyPreserveHost On
    ProxyRequests Off
    AllowEncodedSlashes NoDecode

    <Location "/">
        ProxyPass "http://127.0.0.1:5678/"
        ProxyPassReverse "http://127.0.0.1:5678/"
        Require all granted
    </Location>

    ErrorLog ${APACHE_LOG_DIR}/n8n-error.log
    CustomLog ${APACHE_LOG_DIR}/n8n-access.log combined
</VirtualHost>

{% if enable_https|default(false)|bool %}
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName {{ n8n_domain }}
    ServerAdmin webmaster@{{ n8n_domain }}

    DocumentRoot /var/www/html

    ProxyPreserveHost On
    ProxyRequests Off
    AllowEncodedSlashes NoDecode

    <Location "/">
        ProxyPass "http://127.0.0.1:5678/"
        ProxyPassReverse "http://127.0.0.1:5678/"
        Require all granted
    </Location>

    ErrorLog ${APACHE_LOG_DIR}/n8n-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/n8n-ssl-access.log combined

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/{{ n8n_domain }}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ n8n_domain }}/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>
{% endif %}
